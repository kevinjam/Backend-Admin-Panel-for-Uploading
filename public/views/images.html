<!DOCTYPE html>
<html>
<head>
	<title></title>
</head>
<body>

<h2>Images</h2>
<hr>

<div class="row">
<div class="col-lg-3">
<h4>Add WallPaper</h4>
<form id="image-form">
<div class="form-group">

<label for="category"> Select Category</label>
	<select id="category" class="form-control"></select>
</div>

<div class="form-group">
	<label for="title">Title</label>
	<input type="text" class="form-control" id="title">
	<div class="invalid-feedback">Please enter title</div>
</div>


<div class="form-group">
	<label for="desc">Description</label>
	<input type="text" class="form-control" id="desc">
	<div class="invalid-feedback">Please enter Description</div>
</div>


<div class="form-group">
	<label for="wallpaper">Wallpaper</label>
	<input type="file" class="form-control" id="wallpaper">
	<div class="invalid-feedback">Please enter Wallpaper</div>
</div>
	
<div class="form-group">
	
	<Buttom type="button" class="btn btn-primary" id="btn-save">Save wallpaper</Buttom>
</div>

</form>

</div>


<div class="col-lg-9">
	<img src="img-wallpaper" width="800" height="400">
</div>

</div>

<script type="text/javascript">


    //preview Image
    function previewWallpaper(thumbnail) {
        if (thumbnail.files && thumbnail.files[0]) {
            var reader = new FileReader();
            reader.onload = function (ev) {
                $("#img-wallpaper").attr('src', ev.target.result);


            }
            reader.readAsDataURL(thumbnail.files[0]);
        }
    }

    $("#wallpaper").change(function () {
        previewWallpaper(this);

    });


    var dbCategories = firebase.database().ref("categories");
    dbCategories.once("value").then(function(categories){
    categories.forEach(function(category){
	$("#category").append("<option value='"+category.key+"'>"+category.key+"</option>");

});
    });
  var validImageTypes = ["image/gif", "image/jpeg", "image/png"];
    $("#btn-save").click(function () {
        $("#tile").removeClass("is-invalid");
        $("#desc").removeClass("is-invalid");
        $("#wallpaper").removeClass("is-invalid");
        var title = $("#title").val();
        var desc = $("#desc").val();
        var wallpaper = $("#wallpaper").prop("files")[0];
        if (!title) {
            $("#title").addClass("is-invalid");
            return;
        }
        if (!desc) {
            $("#desc").addClass("is-invalid");
            return;
        }
        if (wallpaper == null) {
            $("#wallpaper").addClass("is-invalid");
            return;
        }
        if ($.inArray(thumbnail["type"], validImageTypes) < 0) {
            $("#wallpaper").addClass("is-invalid");
            return;
        }
        var database = firebase.database().ref("categories/" + catname);
        database.once("value").then(function (snapshot) {

            if (snapshot.exists()) {
                $("#result").attr("class", "alert alert-danger");
                $("#result").html("Category already exist");
                resetFrom();
            } else {
                //1. upload the selected thumbnail to firebase storage
                var name = thumbnail["name"];
                var ext = name.substring(name.lastIndexOf("."), name.length);
                var thumbname = new Date().getTime();
                var storageRef = firebase.storage().ref(catname + "/" + thumbname + ext);
                var uploadTask = storageRef.put(thumbnail);
                uploadTask.on("state_changed",
                    function progress(snapshot) {
                        var percentage = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        $("#upload-progress").html(Math.round(percentage) + "%");
                        $("#upload-progress").attr("style", "width:" + percentage + "%");
                    },
                    function error(err) {
                    },
                    function complete() {
                        var thumbnailUrl = uploadTask.snapshot.downloadURL;

                        var cat = {
                            "thumbnail": thumbnailUrl,
                            "desc": desc
                        };
                        database.set(cat, function (err) {
                            if (err) {
                                $("#result").attr("class", "alert alert-danger");
                                $("#result").html(err.message);
                            } else {
                                $("#result").attr("class", "alert alert-success");
                                $("#result").html("Category added");
                            }
                            resetFrom();
                        });
                    }
                );
            }
        });
    });




</script>



</body>
</html>